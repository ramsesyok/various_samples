# ベンチマーク

このベンチマークは [**このスクリプト**](../../scripts/bench/bench.py) を使って CMake 経由で実行されています。3つのベンチマークシナリオがあります：

- [ヘッダファイルのインクルードコスト](#cost-of-including-the-header)
- [アサートマクロのコンパイル時間コスト](#cost-of-an-assertion-macro)
- [多数のアサート実行時の実行速度](#runtime-benchmarks)

## 使用したコンパイラ：

- **Windows**: Visual Studio 2017 Community (15.8.1+)
- **Windows**: MinGW GCC 8.1.0
- **Linux**: GCC 6.3.0 / Clang 4.0.0

## 実行環境（Intel i7 3770k、RAM 16GB）：

- Windows 7（SSD）
- Ubuntu 17.04（VirtualBox 上、HDD）

- **doctest** バージョン：2.2.0（2018年12月）
- [**Catch2**](https://github.com/catchorg/Catch2) バージョン：2.3.0（2018年7月）

---

## コンパイル時間ベンチマーク

### ヘッダインクルードのコスト

このテストは doctest や Catch のような「シングルヘッダ／ヘッダオンリー」フレームワークに特有のものです。

201 個のソースファイルを生成し、200個にダミー関数（`int f135() { return 135; }` のような）を定義し、`main.cpp` にてそれらをすべて呼び出してリンクが最適化を省略しないようにします。

| フレームワーク | ベースライン | 実装 (`main.cpp` で定義) | 全ファイルにヘッダ追加 | 無効化時 |
|----------------|--------------|--------------------------|--------------------------|----------|
| doctest (MSVC Debug) | 4.89s | 6.21s | 8.33s | 6.39s |
| Catch (MSVC Debug) | 4.82s | 7.83s | 88.85s | 88.72s |

### 結論

- **doctest のヘッダ**は、MSVC 上で **約 36 倍軽量**（11〜23ms vs 400ms）
- **Catch2** では `CATCH_CONFIG_DISABLE` でマクロは消えるが、ヘッダのインクルードコストは変わらない
- doctest はヘッダを極力軽量に保つため、**フォワード宣言を使用し、余計な標準ヘッダを含まない設計**

---

## アサートマクロのコンパイル時間

50,000個のアサートを生成して、それぞれのケースでのビルド時間を計測。doctest 特有の最適化オプションもテスト。

| フレームワーク | 通常 `CHECK(a==b)` | 高速化オプションあり | `CHECK_EQ(a,b)` | 高速化あり | 無効化 |
|----------------|--------------------|-----------------------|------------------|-------------|--------|
| doctest (MSVC Release) | 58.73s | 20.73s | 26.07s | **6.43s** | **1.83s** |
| Catch (MSVC Release) | 448.68s | 168.67s | - | - | 10.20s |

### 結論

- doctest の `DOCTEST_CONFIG_SUPER_FAST_ASSERTS` により、アサートのコンパイル時間が大幅に短縮（50k アサート → 6s）
- `CHECK_EQ(a,b)` のようなバイナリアサートは、より簡潔にコンパイルでき、さらに高速
- `DOCTEST_CONFIG_DISABLE` を使うと、アサートを完全に除去（ヘッダも軽量化）

---

## 実行時間ベンチマーク

アサートが1000万回通るだけのループで実行時間を比較。`INFO(i)` 付きのケースも評価。

```cpp
for (int i = 0; i < 10000000; ++i)
    CHECK(i == i);
```

### 結果例（MSVC Release）

| フレームワーク | `CHECK` のみ | `INFO + CHECK` |
|----------------|--------------|-----------------|
| doctest        | **0.40s**    | 1.47s           |
| Catch2         | 0.76s        | **7.60s**       |

### 結論

- doctest は単純アサートで **約20% 高速**
- 変数ログ込みのアサートでは、**Catch の数倍〜18倍** 高速（特に INFO 使用時）

---

## 最後に

- doctest の軽量さとスピードは、**膨大なアサート数**のある大規模コードで威力を発揮
- より実践的なベンチマーク例として、[**Baptiste Wicht 氏のブログ記事**](http://baptiste-wicht.com/posts/2016/09/blazing-fast-unit-test-compilation-with-doctest-11.html) もおすすめ

---

[ホームに戻る](readme.md#reference)
